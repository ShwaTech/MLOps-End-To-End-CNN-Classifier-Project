pipeline {
  agent any
  environment {
    AWS_ACCOUNT_ID         = '123456789012'
    ECR_REPOSITORY         = '123456789012.dkr.ecr.us-east-1.amazonaws.com/flask-app'
    AWS_ACCESS_KEY_ID      = credentials('aws-access-key-id')
    AWS_SECRET_ACCESS_KEY  = credentials('aws-secret-access-key')
    AWS_DEFAULT_REGION     = 'us-east-1'
  }
  
  stages {
    stage('Continuous Integration') {
      steps {
        echo "Linting repository"
        echo "Running unit tests"
      }
    }
  
    stage('Login to ECR') {
      steps {
        sh '''
          aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID
          aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY
          aws configure set default.region $AWS_DEFAULT_REGION

          aws ecr get-login-password --region $AWS_DEFAULT_REGION | \
          docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com
        '''
      }
    }
    
    stage('Build & Push Docker Image') {
      steps {
        sh '''
          docker build -t $ECR_REPOSITORY:latest .
          docker push $ECR_REPOSITORY:latest
        '''
      }
    }
    
    stage('Continuous Deployment') {
      steps {
        sshagent(['ssh_key']) {
          sh '''
          ssh -o StrictHostKeyChecking=no ubuntu@3.232.58.183 "
            cd /home/ubuntu/ &&
            wget -O docker-compose.yml https://raw.githubusercontent.com/entbappy/Chest-Disease-Classification-from-Chest-CT-Scan-Image/main/docker-compose.yml &&
            export IMAGE_NAME=$ECR_REPOSITORY:latest &&
            aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.us-east-1.amazonaws.com &&
            docker compose pull &&
            docker compose up -d
          "
          '''
        }
      }
    }
    }
  
  post {
    always {
      sh 'docker system prune -f'
    }
  }
}
